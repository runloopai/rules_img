[test]
name = layer_source_directory
description = Test layer creation with a source directory (nested structure)

[file]
name = srcdir/a/file1.txt
Content of file 1 in subdirectory a

[file]
name = srcdir/b/file2.txt
Content of file 2 in subdirectory b

[file]
name = srcdir/c/nested/deep.txt
Content of deeply nested file

[command]
subcommand = layer
args = --add /myroot=srcdir layer.tar.gz
expect_exit = 0

[assert]
file_exists = layer.tar.gz
file_size_gt = layer.tar.gz, 0
file_valid_gzip = layer.tar.gz

# Verify the directory symlink is created (pointing to CAS tree)
tar_entry_exists = layer.tar.gz, myroot
tar_entry_type = layer.tar.gz, myroot, symlink

# Verify the layer structure is valid
layer_invariants_intact = layer.tar.gz

# Verify the output file hash (deterministic due to normalized metadata)
file_sha256 = layer.tar.gz, "b4dc45eaca743d8f22e5e6aab1740cfc9b071d3b05c4bf952e5956dd82c38371"
